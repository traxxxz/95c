<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>محرر الصور المتقدم</title>
    <!-- تحميل Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* خط إنتر لجمالية التصميم */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb; /* خلفية فاتحة */
        }
        /* لإخفاء شريط التمرير الأفقي في الأجهزة الصغيرة */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }
        /* تنسيق الأزرار والشرائح */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 16px;
            height: 16px;
            background: #2563eb;
            cursor: pointer;
            border-radius: 50%;
            transition: background 0.2s;
        }
        input[type="range"]:active::-webkit-slider-thumb {
            background: #1e40af;
        }
        .control-card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        /* لإظهار خلفية متفحصة (Checkerboard) عند وجود شفافية */
        #imageCanvas {
            background-image: linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
        .number-input {
            appearance: textfield; /* لتثبيت عرض خانة الإدخال الرقمية */
        }
        /* إخفاء أزرار الزيادة/النقصان لـ Chrome, Safari, Edge, Opera */
        .number-input::-webkit-outer-spin-button,
        .number-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .caption-toast {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen flex flex-col items-center">

    <h1 class="text-3xl font-extrabold text-gray-800 mb-6 text-center">أداة تحرير الصور (جودة ولون)</h1>

    <!-- منطقة التحميل والصورة -->
    <div class="w-full max-w-4xl bg-white p-6 rounded-xl control-card mb-6">
        <label for="imageUpload" class="block text-sm font-medium text-gray-700 mb-3">
            الخطوة 1: رفع الصورة
        </label>
        <input type="file" id="imageUpload" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer rounded-lg border border-gray-300 p-2">
    </div>

    <!-- منطقة التحكم -->
    <div class="w-full max-w-4xl bg-white p-6 rounded-xl control-card mb-6 grid grid-cols-1 md:grid-cols-4 gap-6">
        
        <!-- قسم الحدة (Sharpness) -->
        <div>
            <label for="sharpness" class="block text-lg font-bold text-gray-800 mb-2">
                1. الحدة (Sharpness)
            </label>
            <p class="text-sm text-gray-500 mb-3">تحسين وضوح التفاصيل والنقاء. (0 - 10)</p>
            <div class="flex items-center space-x-2 space-x-reverse">
                <input type="range" id="sharpness" min="0" max="10" value="0" step="0.1" class="flex-grow h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                <input type="number" id="sharpnessInput" min="0" max="10" value="0.0" step="0.1" 
                       class="number-input w-20 text-center border border-gray-300 rounded-lg py-1 text-blue-600 font-semibold focus:ring-blue-500 focus:border-blue-500">
            </div>
        </div>

        <!-- قسم السطوع (Brightness) -->
        <div>
            <label for="brightness" class="block text-lg font-bold text-gray-800 mb-2">
                2. السطوع (Brightness)
            </label>
            <p class="text-sm text-gray-500 mb-3">لإضاءة الصورة بشكل عام أو تغميقها. (-100 - 100)</p>
            <div class="flex items-center space-x-2 space-x-reverse">
                <input type="range" id="brightness" min="-100" max="100" value="0" step="1" class="flex-grow h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                <input type="number" id="brightnessInput" min="-100" max="100" value="0" step="1" 
                       class="number-input w-20 text-center border border-gray-300 rounded-lg py-1 text-blue-600 font-semibold focus:ring-blue-500 focus:border-blue-500">
            </div>
        </div>

        <!-- قسم التباين (Contrast) -->
        <div>
            <label for="contrast" class="block text-lg font-bold text-gray-800 mb-2">
                3. التباين (Contrast)
            </label>
            <p class="text-sm text-gray-500 mb-3">ضبط التباين وإبراز الفروقات بين الألوان. (-100 - 100)</p>
            <div class="flex items-center space-x-2 space-x-reverse">
                <input type="range" id="contrast" min="-100" max="100" value="0" step="1" class="flex-grow h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                <input type="number" id="contrastInput" min="-100" max="100" value="0" step="1" 
                       class="number-input w-20 text-center border border-gray-300 rounded-lg py-1 text-blue-600 font-semibold focus:ring-blue-500 focus:border-blue-500">
            </div>
        </div>
        
        <!-- قسم التشبع (Saturation) -->
        <div>
            <label for="saturation" class="block text-lg font-bold text-gray-800 mb-2">
                4. التشبع (Saturation)
            </label>
            <p class="text-sm text-gray-500 mb-3">كثافة جميع الألوان في الصورة. (-100 - 100)</p>
            <div class="flex items-center space-x-2 space-x-reverse">
                <input type="range" id="saturation" min="-100" max="100" value="0" step="1" class="flex-grow h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                <input type="number" id="saturationInput" min="-100" max="100" value="0" step="1" 
                       class="number-input w-20 text-center border border-gray-300 rounded-lg py-1 text-blue-600 font-semibold focus:ring-blue-500 focus:border-blue-500">
            </div>
        </div>

        <!-- قسم الحيوية (Vibrance) -->
        <div class="md:col-span-4 lg:col-span-1">
            <label for="vibrance" class="block text-lg font-bold text-gray-800 mb-2">
                5. حيوية الألوان (Vibrance)
            </label>
            <p class="text-sm text-gray-500 mb-3">إبراز الألوان الساطعة الأقل تشبعًا. (-100 - 100)</p>
            <div class="flex items-center space-x-2 space-x-reverse">
                <input type="range" id="vibrance" min="-100" max="100" value="0" step="1" class="flex-grow h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                <input type="number" id="vibranceInput" min="-100" max="100" value="0" step="1" 
                       class="number-input w-20 text-center border border-gray-300 rounded-lg py-1 text-blue-600 font-semibold focus:ring-blue-500 focus:border-blue-500">
            </div>
        </div>
    </div>
    
    <!-- قسم أدوات الذكاء الاصطناعي -->
    <div class="w-full max-w-4xl bg-white p-6 rounded-xl control-card mb-6 space-y-6">
        <h2 class="text-xl font-bold text-gray-800 text-center">✨ أدوات Gemini الإبداعية</h2>
        <!-- أداة عزل الخلفية -->
        <div>
            <label class="block text-lg font-semibold text-gray-800 mb-2">أداة عزل الخلفية</label>
            <p class="text-sm text-gray-500 mb-3">استخدم الذكاء الاصطناعي لإزالة الخلفية مع الحفاظ على الكائن الرئيسي.</p>
            <button id="removeBackgroundButton" class="w-full py-3 bg-red-600 text-white font-bold rounded-lg hover:bg-red-700 transition duration-150 shadow-md shadow-red-300 disabled:opacity-50" disabled>
                إزالة الخلفية وتعيينها شفافة
            </button>
        </div>
        <hr/>
        <!-- أداة تحسين الجودة -->
        <div>
            <label class="block text-lg font-semibold text-gray-800 mb-2">تحسين الجودة</label>
            <p class="text-sm text-gray-500 mb-3">استخدم Gemini لتحسين دقة الصورة وإصلاح العيوب وزيادة الوضوح.</p>
            <button id="enhanceQualityButton" class="w-full py-3 bg-teal-600 text-white font-bold rounded-lg hover:bg-teal-700 transition duration-150 shadow-md shadow-teal-300 disabled:opacity-50" disabled>
                ✨ تحسين الجودة
            </button>
        </div>
        <hr/>
        <!-- أداة توليد التعليق والهاشتاجات -->
        <div>
            <label class="block text-lg font-semibold text-gray-800 mb-2">وصف الصورة والهاشتاجات</label>
            <p class="text-sm text-gray-500 mb-3">أداة لتحليل صورتك واقتراح وصف إبداعي وهاشتاجات مناسبة.</p>
            <div class="flex space-x-2 space-x-reverse">
                <button id="generateCaptionButton" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md shadow-indigo-300 disabled:opacity-50" disabled>
                    ✨ توليد تعليق
                </button>
                <button id="generateHashtagsButton" class="w-full py-3 bg-sky-600 text-white font-bold rounded-lg hover:bg-sky-700 transition duration-150 shadow-md shadow-sky-300 disabled:opacity-50" disabled>
                    ✨ اقتراح هاشتاجات
                </button>
            </div>
        </div>
        <hr/>
        <!-- أداة إعادة التصور -->
        <div>
             <label for="reimaginePrompt" class="block text-lg font-semibold text-gray-800 mb-2">إعادة تصور الصورة</label>
             <p class="text-sm text-gray-500 mb-3">صف تعديلاً إبداعيًا (مثال: "اجعلها تبدو كلوحة مائية" أو "أضف أضواء نيون").</p>
             <input type="text" id="reimaginePrompt" placeholder="صف التعديل المطلوب هنا..." class="w-full border border-gray-300 rounded-lg p-3 mb-3 focus:ring-blue-500 focus:border-blue-500">
             <button id="reimagineButton" class="w-full py-3 bg-purple-600 text-white font-bold rounded-lg hover:bg-purple-700 transition duration-150 shadow-md shadow-purple-300 disabled:opacity-50" disabled>
                ✨ إعادة تصور الصورة
            </button>
        </div>
    </div>

    <!-- منطقة العرض والتحميل -->
    <div class="w-full max-w-4xl bg-white p-6 rounded-xl control-card relative">
        <!-- حاوية رسالة التعليق -->
        <div id="captionToast" class="caption-toast absolute top-4 right-4 max-w-sm bg-gray-800 text-white p-4 rounded-lg shadow-lg z-20 opacity-0 translate-y-2 pointer-events-none">
            <div class="flex items-start">
                <div class="flex-grow">
                    <p id="captionText" class="mb-2" style="display: none;"></p>
                    <p id="hashtagText" class="text-sky-400 text-sm" style="display: none;"></p>
                </div>
                <button id="closeCaptionToast" class="ml-4 text-gray-400 hover:text-white">&times;</button>
            </div>
        </div>


        <div id="loadingIndicator" class="absolute inset-0 bg-white bg-opacity-80 flex items-center justify-center rounded-xl z-10 hidden">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
            <p class="mr-4 text-blue-600 font-medium">جارٍ معالجة الصورة...</p>
        </div>
        <canvas id="imageCanvas" class="w-full h-auto rounded-lg border-2 border-dashed border-gray-300"></canvas>
        <p id="message" class="text-center text-gray-500 mt-4">يرجى رفع صورة للبدء في التعديل.</p>

        <button id="downloadButton" class="mt-6 w-full py-3 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition duration-150 shadow-md shadow-green-300 disabled:opacity-50" disabled>
            تحميل الصورة المعدلة
        </button>
    </div>

    <p class="text-xs text-gray-400 mt-4 text-center">
        **ملاحظة:** يتم تطبيق التعديلات محليًا في المتصفح للحفاظ على خصوصيتك (باستثناء أدوات Gemini التي تتطلب اتصالاً بالخادم).
    </p>

    <script>
        const imageUpload = document.getElementById('imageUpload');
        const imageCanvas = document.getElementById('imageCanvas');
        const ctx = imageCanvas.getContext('2d');
        const message = document.getElementById('message');
        const downloadButton = document.getElementById('downloadButton');
        const loadingIndicator = document.getElementById('loadingIndicator');

        // Sliders
        const sharpnessSlider = document.getElementById('sharpness');
        const brightnessSlider = document.getElementById('brightness');
        const contrastSlider = document.getElementById('contrast');
        const saturationSlider = document.getElementById('saturation');
        const vibranceSlider = document.getElementById('vibrance');
        
        // Gemini Buttons
        const removeBackgroundButton = document.getElementById('removeBackgroundButton');
        const enhanceQualityButton = document.getElementById('enhanceQualityButton');
        const generateCaptionButton = document.getElementById('generateCaptionButton');
        const generateHashtagsButton = document.getElementById('generateHashtagsButton');
        const reimagineButton = document.getElementById('reimagineButton');

        // Inputs
        const sharpnessInput = document.getElementById('sharpnessInput');
        const brightnessInput = document.getElementById('brightnessInput');
        const contrastInput = document.getElementById('contrastInput');
        const saturationInput = document.getElementById('saturationInput');
        const vibranceInput = document.getElementById('vibranceInput');
        const reimaginePrompt = document.getElementById('reimaginePrompt');

        // Caption Toast UI
        const captionToast = document.getElementById('captionToast');
        const captionText = document.getElementById('captionText');
        const hashtagText = document.getElementById('hashtagText');
        const closeCaptionToast = document.getElementById('closeCaptionToast');

        let originalImage = null;
        let imageReady = false;

        // Constants for Gemini API
        const API_KEY = "";
        const IMAGE_MODEL = "gemini-2.5-flash-image-preview";
        const TEXT_MODEL = "gemini-2.5-flash-preview-05-20";
        const IMAGE_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${IMAGE_MODEL}:generateContent?key=${API_KEY}`;
        const TEXT_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${API_KEY}`;

        const allActionButtons = [downloadButton, removeBackgroundButton, enhanceQualityButton, generateCaptionButton, generateHashtagsButton, reimagineButton];

        // =================================================================
        // DEBOUNCE UTILITY FOR SLIDERS
        // =================================================================
        function debounce(func, timeout = 150) {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => { func.apply(this, args); }, timeout);
            };
        }
        const debouncedUpdateFilters = debounce(updateImageFilters);


        // =================================================================
        // 1. إدارة ملف الصورة والتحميل
        // =================================================================

        imageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            message.textContent = "جارٍ تحميل الصورة...";
            imageReady = false;
            allActionButtons.forEach(btn => btn.disabled = true);
            loadingIndicator.classList.remove('hidden');

            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    originalImage = img;
                    imageCanvas.width = img.width;
                    imageCanvas.height = img.height;
                    ctx.drawImage(originalImage, 0, 0);

                    message.textContent = "تم تحميل الصورة بنجاح. ابدأ التعديل.";
                    imageReady = true;
                    loadingIndicator.classList.add('hidden');
                    allActionButtons.forEach(btn => btn.disabled = false);
                    
                    updateImageFilters();
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        // =================================================================
        // 2. تطبيق التعديلات عند تحريك الشرائح أو إدخال الأرقام
        // =================================================================

        const controls = [
            { slider: sharpnessSlider, input: sharpnessInput },
            { slider: brightnessSlider, input: brightnessInput },
            { slider: contrastSlider, input: contrastInput },
            { slider: saturationSlider, input: saturationInput },
            { slider: vibranceSlider, input: vibranceInput }
        ];

        controls.forEach(({ slider, input }) => {
            slider.addEventListener('input', () => {
                const decimalPlaces = slider.step.includes('.') ? 1 : 0;
                input.value = parseFloat(slider.value).toFixed(decimalPlaces);
                if (imageReady) debouncedUpdateFilters();
            });
            input.addEventListener('change', () => {
                let value = parseFloat(input.value);
                const min = parseFloat(slider.min);
                const max = parseFloat(slider.max);
                const decimalPlaces = slider.step.includes('.') ? 1 : 0;
                if (isNaN(value)) {
                    value = parseFloat(slider.value);
                } else {
                    if (value < min) value = min;
                    if (value > max) value = max;
                }
                input.value = value.toFixed(decimalPlaces);
                slider.value = value;
                if (imageReady) debouncedUpdateFilters();
            });
        });

        // =================================================================
        // 3. وظائف معالجة الصور (Sharpen & Color)
        // =================================================================

        function updateImageFilters() {
            if (!originalImage) return;
            loadingIndicator.classList.remove('hidden');
            try {
                ctx.drawImage(originalImage, 0, 0);
                let imageData = ctx.getImageData(0, 0, imageCanvas.width, imageCanvas.height);
                const brightness = parseFloat(brightnessSlider.value);
                const contrast = parseFloat(contrastSlider.value);
                const saturation = parseFloat(saturationSlider.value) / 100;
                const vibrance = parseFloat(vibranceSlider.value) / 100;
                const sharpness = parseFloat(sharpnessSlider.value);

                if (brightness !== 0 || contrast !== 0 || saturation !== 0 || vibrance !== 0) {
                    applyColorFilters(imageData.data, brightness, contrast, saturation, vibrance);
                }
                if (sharpness > 0) {
                    imageData = applySharpnessFilter(imageData, sharpness, imageCanvas.width, imageCanvas.height);
                }
                ctx.putImageData(imageData, 0, 0);
            } catch (e) {
                console.error("خطأ في تطبيق الفلاتر:", e);
                message.textContent = "حدث خطأ أثناء معالجة الصورة.";
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        function applyColorFilters(data, brightness, contrast, saturation, vibrance) {
            const factor = (259 * (contrast + 100)) / (255 * (100 - contrast));
            for (let i = 0; i < data.length; i += 4) {
                let r = data[i], g = data[i + 1], b = data[i + 2];
                r += brightness; g += brightness; b += brightness;
                r = factor * (r - 128) + 128; g = factor * (g - 128) + 128; b = factor * (b - 128) + 128;
                if (saturation !== 0) {
                    const avg = (r + g + b) / 3;
                    r = avg + (r - avg) * (1 + saturation);
                    g = avg + (g - avg) * (1 + saturation);
                    b = avg + (b - avg) * (1 + saturation);
                }
                if (vibrance !== 0) {
                    const avg = (r + g + b) / 3;
                    const max = Math.max(r, g, b);
                    const amount = (vibrance > 0 ? max : avg) * vibrance;
                    r += (r === max ? 0 : 1) * amount;
                    g += (g === max ? 0 : 1) * amount;
                    b += (b === max ? 0 : 1) * amount;
                }
                data[i] = Math.max(0, Math.min(255, r));
                data[i + 1] = Math.max(0, Math.min(255, g));
                data[i + 2] = Math.max(0, Math.min(255, b));
            }
        }

        function applySharpnessFilter(imageData, sharpness, width, height) {
            const originalData = imageData.data;
            const outputData = new Uint8ClampedArray(originalData.length);
            const pureKernel = [0, -1, 0, -1, 5, -1, 0, -1, 0];
            const sharpnessRatio = sharpness / 10;
            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    const i = (y * width + x) * 4;
                    for (let c = 0; c < 3; c++) {
                        let val = 0;
                        for (let ky = 0; ky < 3; ky++) {
                            for (let kx = 0; kx < 3; kx++) {
                                const pixelIndex = ((y + ky - 1) * width + (x + kx - 1)) * 4 + c;
                                val += originalData[pixelIndex] * pureKernel[ky * 3 + kx];
                            }
                        }
                        const originalPixelValue = originalData[i + c];
                        const blendedValue = originalPixelValue * (1 - sharpnessRatio) + val * sharpnessRatio;
                        outputData[i + c] = Math.max(0, Math.min(255, Math.round(blendedValue)));
                    }
                    outputData[i + 3] = originalData[i + 3];
                }
            }
            for (let i = 0; i < originalData.length; i += 4) {
                if (outputData[i] === 0 && outputData[i + 1] === 0 && outputData[i + 2] === 0) {
                    outputData[i] = originalData[i]; outputData[i + 1] = originalData[i + 1]; outputData[i + 2] = originalData[i + 2]; outputData[i + 3] = originalData[i + 3];
                }
            }
            const newImageData = ctx.createImageData(width, height);
            newImageData.data.set(outputData);
            return newImageData;
        }

        // =================================================================
        // 4. وظائف Gemini API
        // =================================================================
        
        async function callGemini(apiUrl, payload) {
            message.textContent = "✨ جارٍ الاتصال بـ Gemini...";
            loadingIndicator.classList.remove('hidden');
            allActionButtons.forEach(btn => btn.disabled = true);
            
            try {
                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                return await response.json();
            } catch (error) {
                message.textContent = "حدث خطأ أثناء الاتصال بخدمة Gemini.";
                console.error("Fetch/Processing Error:", error);
                return null;
            } finally {
                loadingIndicator.classList.add('hidden');
                if (imageReady) {
                    allActionButtons.forEach(btn => btn.disabled = false);
                }
            }
        }

        // --- أداة عزل الخلفية ---
        removeBackgroundButton.addEventListener('click', async () => {
            if (!imageReady) return;
            const base64Image = await getBase64ImageFromCanvas();
            const payload = {
                contents: [{ parts: [{ text: "Remove the background from this image, leaving the subject clearly isolated on a transparent background. Output the result as an image." }, { inlineData: { mimeType: "image/png", data: base64Image } }] }],
                generationConfig: { responseModalities: ['IMAGE'] },
            };
            const result = await callGemini(IMAGE_API_URL, payload);
            const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
            if (base64Data) {
                await updateImageWithNewData(`data:image/png;base64,${base64Data}`);
                message.textContent = "تمت إزالة الخلفية بنجاح!";
            } else {
                message.textContent = "فشل عزل الخلفية. لم يتم الحصول على بيانات صالحة.";
                console.error("API Error:", result);
            }
        });
        
        // --- أداة تحسين الجودة ---
        enhanceQualityButton.addEventListener('click', async () => {
            if (!imageReady) return;
            const base64Image = await getBase64ImageFromCanvas();
            const payload = {
                contents: [{ parts: [{ text: "Significantly enhance the quality of this image. Fix compression artifacts, increase sharpness and detail, and intelligently upscale the resolution. Make the colors more vibrant and clear. Output the result as an image." }, { inlineData: { mimeType: "image/png", data: base64Image } }] }],
                generationConfig: { responseModalities: ['IMAGE'] },
            };
            const result = await callGemini(IMAGE_API_URL, payload);
            const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
            if (base64Data) {
                await updateImageWithNewData(`data:image/png;base64,${base64Data}`);
                message.textContent = "تم تحسين جودة الصورة بنجاح!";
            } else {
                message.textContent = "فشل تحسين الجودة. حاول مرة أخرى.";
                console.error("API Error:", result);
            }
        });

        // --- أداة توليد التعليق ---
        generateCaptionButton.addEventListener('click', async () => {
            if (!imageReady) return;
            const base64Image = await getBase64ImageFromCanvas();
            const payload = {
                contents: [{ parts: [{ text: "اكتب تعليقًا إبداعيًا ووصفًا قصيرًا لهذه الصورة باللغة العربية. اجعل الوصف جذابًا ومناسبًا لمشاركته على وسائل التواصل الاجتماعي." }, { inlineData: { mimeType: "image/png", data: base64Image } }] }],
            };
            const result = await callGemini(TEXT_API_URL, payload);
            const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
            if (text) {
                showCaptionToast(text, null);
                message.textContent = "تم توليد التعليق بنجاح!";
            } else {
                message.textContent = "فشل توليد التعليق.";
                console.error("API Error:", result);
            }
        });

        // --- أداة اقتراح الهاشتاجات ---
        generateHashtagsButton.addEventListener('click', async () => {
            if (!imageReady) return;
            const base64Image = await getBase64ImageFromCanvas();
            const payload = {
                contents: [{ parts: [{ text: "Based on this image, generate a list of 5-10 relevant and popular hashtags in Arabic for social media platforms. Format them as a single line, space-separated string, like: #هاشتاج1 #هاشتاج2" }, { inlineData: { mimeType: "image/png", data: base64Image } }] }],
            };
            const result = await callGemini(TEXT_API_URL, payload);
            const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
            if (text) {
                showCaptionToast(null, text);
                message.textContent = "تم اقتراح الهاشتاجات بنجاح!";
            } else {
                message.textContent = "فشل اقتراح الهاشتاجات.";
                console.error("API Error:", result);
            }
        });
        
        // --- أداة إعادة التصور ---
        reimagineButton.addEventListener('click', async () => {
            if (!imageReady) return;
            const prompt = reimaginePrompt.value.trim();
            if (!prompt) {
                message.textContent = "يرجى كتابة وصف للتعديل المطلوب أولاً.";
                return;
            }
            const base64Image = await getBase64ImageFromCanvas();
            const payload = {
                contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: base64Image } }] }],
                generationConfig: { responseModalities: ['IMAGE'] },
            };
             const result = await callGemini(IMAGE_API_URL, payload);
            const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
            if (base64Data) {
                await updateImageWithNewData(`data:image/png;base64,${base64Data}`);
                message.textContent = "تمت إعادة تصور الصورة بنجاح!";
            } else {
                message.textContent = "فشل إعادة تصور الصورة. حاول وصفًا مختلفًا.";
                console.error("API Error:", result);
            }
        });

        // =================================================================
        // 5. وظائف مساعدة
        // =================================================================

        function getBase64ImageFromCanvas() {
            return new Promise((resolve, reject) => {
                imageCanvas.toBlob((blob) => {
                    if (!blob) return reject(new Error("Failed to create blob."));
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                }, 'image/png');
            });
        }

        function updateImageWithNewData(dataUrl) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    originalImage = img;
                    imageCanvas.width = img.width;
                    imageCanvas.height = img.height;
                    ctx.clearRect(0, 0, img.width, img.height);
                    ctx.drawImage(originalImage, 0, 0);
                    // Reset sliders
                    controls.forEach(({ slider, input }) => {
                        const defaultValue = slider.getAttribute('value');
                        slider.value = defaultValue;
                        input.value = defaultValue;
                         if (input.step.includes('.')) {
                            input.value = parseFloat(defaultValue).toFixed(1);
                        }
                    });
                    resolve();
                };
                img.src = dataUrl;
            });
        }

        async function fetchWithRetry(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) return response;
                    if (i < maxRetries - 1) await new Promise(res => setTimeout(res, Math.pow(2, i) * 1000));
                } catch (error) {
                    if (i < maxRetries - 1) await new Promise(res => setTimeout(res, Math.pow(2, i) * 1000));
                    else throw error;
                }
            }
            throw new Error('Maximum retries reached.');
        }
        
        function showCaptionToast(caption, hashtags) {
            if (caption !== null) {
                captionText.innerText = caption;
                captionText.style.display = 'block';
            }
            if (hashtags !== null) {
                hashtagText.innerText = hashtags;
                hashtagText.style.display = 'block';
            }
            captionToast.classList.remove('opacity-0', 'translate-y-2', 'pointer-events-none');
        }
        
        closeCaptionToast.addEventListener('click', () => {
            captionToast.classList.add('opacity-0', 'translate-y-2', 'pointer-events-none');
            // Hide text but don't clear content until next call
            captionText.style.display = 'none';
            hashtagText.style.display = 'none';
        });

        // =================================================================
        // 6. وظيفة تحميل الصورة المعدلة
        // =================================================================

        downloadButton.addEventListener('click', () => {
            if (!imageReady) {
                message.textContent = "يرجى رفع صورة أولاً للتحميل.";
                return;
            }
            const dataURL = imageCanvas.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = dataURL;
            a.download = 'صورة_معدلة_بواسطة_Gemini.png';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });

    </script>
</body>
</html>

